<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cargar Camiones - Log√≠sticas PEPE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .loader { width: 40px; display:none }
    .overload { background-color: #ffb3b3; }
    .btn-full { width:100%; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">‚Üê Volver | Log√≠sticas PEPE</a>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="text-center mb-4">üöö Gesti√≥n de Camiones</h2>

  <!-- =================== CREAR PAQUETE =================== -->
  <div class="card mb-4" id="crear-paquete">
    <div class="card-header bg-primary text-white">üì¶ Crear Paquete</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <input type="number" id="pesoPaquete" class="form-control" placeholder="Peso (kg)">
        </div>
        <div class="col-md-3">
          <select id="origenPaquete" class="form-select">
            <option selected disabled>Seleccionar origen</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="destinoPaquete" class="form-select">
            <option selected disabled>Seleccionar destino</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary btn-full" id="btnCrearPaquete">Crear Paquete</button>
        </div>
      </div>
      <div id="msgCrearPaquete" class="mt-2 text-success"></div>
    </div>
  </div>

  <!-- =================== CREAR CAMION =================== -->
  <div class="card mb-4" id="crear-camion">
    <div class="card-header bg-success text-white">üöõ Crear Cami√≥n</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <input type="number" id="capacidadCamion" class="form-control" placeholder="Capacidad (kg)">
        </div>
        <div class="col-md-4">
          <button class="btn btn-success btn-full" id="btnCrearCamion">Crear Cami√≥n</button>
        </div>
      </div>
      <div id="msgCrearCamion" class="mt-2 text-success"></div>
    </div>
  </div>

  <!-- =================== CARGAR CAMIONES =================== -->
  <div class="card mb-4" id="cargar-camiones">
    <div class="card-header bg-secondary text-white">üîß Cargar Camiones</div>
    <div class="card-body">
      <p class="fw-bold">Eleg√≠ un cami√≥n:</p>
      <select id="selectCamion" class="form-select mb-3"></select>
      <div class="row g-3">
        <div class="col-md-6">
          <button class="btn btn-dark btn-full" id="btnManual">Carga Manual</button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-info btn-full text-white" id="btnAutomatico">Carga Autom√°tica</button>
        </div>
      </div>
      <div id="msgCarga" class="mt-3 fw-bold"></div>

      <div id="cargaManual" class="mt-4" style="display:none;">
        <hr>
        <h5>Seleccion√° paquetes:</h5>
        <p>Peso restante: <b id="pesoRestante">0 kg</b></p>
        <div id="listaPaquetes" class="mt-3"></div>
        <button id="btnConfirmarManual" class="btn btn-success mt-3 btn-full">Confirmar Carga</button>
        <div id="msgCargaManual" class="mt-3 text-success fw-bold"></div>
      </div>

    </div>
  </div>
</div>

<script>
  const API = "http://localhost:8080/neo";

  // === CARGAR CIUDADES ===
  async function cargarCiudades() {
    try {
      const res = await fetch(`${API}/ciudad/get/nombres`);
      if (!res.ok) throw new Error("Error al obtener ciudades");
      const ciudades = await res.json();

      const origenSel = document.getElementById("origenPaquete");
      const destinoSel = document.getElementById("destinoPaquete");

      // Limpiamos selects y agregamos placeholder
      origenSel.innerHTML = '<option selected disabled>Seleccionar origen</option>';
      destinoSel.innerHTML = '<option selected disabled>Seleccionar destino</option>';

      // Cargamos todas las ciudades en el select de origen
      ciudades.forEach(c => {
        const option = document.createElement("option");
        option.value = c;
        option.textContent = c;
        origenSel.appendChild(option);
      });

      // üîπ Evento: cuando cambia el origen, cargamos los destinos v√°lidos
      origenSel.addEventListener("change", async () => {
        const origenSeleccionado = origenSel.value;

        destinoSel.innerHTML = '<option selected disabled>Cargando destinos...</option>';
        destinoSel.disabled = true;

        try {
          // Llamamos al DFS para obtener las ciudades alcanzables desde el origen
          const resDFS = await fetch(`${API}/grafo/dfs?inicio=${encodeURIComponent(origenSeleccionado)}`);
          if (!resDFS.ok) throw new Error("Error al obtener destinos");
          const destinos = await resDFS.json();

          // Limpiamos y agregamos las opciones reales
          destinoSel.innerHTML = '<option selected disabled>Seleccionar destino</option>';
          destinos
                  .filter(d => d !== origenSeleccionado) // excluye el mismo origen
                  .forEach(d => {
                    const option = document.createElement("option");
                    option.value = d;
                    option.textContent = d;
                    destinoSel.appendChild(option);
                  });

          destinoSel.disabled = false;
        } catch (err) {
          console.error("Error cargando destinos:", err);
          destinoSel.innerHTML = '<option selected disabled>Error al cargar</option>';
        }
      });

    } catch (e) {
      console.error("Error cargando ciudades:", e);
    }
  }

  cargarCiudades();
  cargarCiudades();

  // === CREAR PAQUETE ===
  document.getElementById("btnCrearPaquete").addEventListener("click", async () => {
    const peso = document.getElementById("pesoPaquete").value;
    const origen = document.getElementById("origenPaquete").value;
    const destino = document.getElementById("destinoPaquete").value;

    if (!peso || !origen || !destino) return alert("Complet√° los datos del paquete.");

    const res = await fetch(`${API}/paquete?peso=${peso}&origen=${origen}&destino=${destino}`, { method: "POST" });
    document.getElementById("msgCrearPaquete").innerText = await res.text();
  });

  // === CREAR CAMI√ìN ===
  document.getElementById("btnCrearCamion").addEventListener("click", async () => {
    const cap = document.getElementById("capacidadCamion").value;
    if (!cap) return alert("Ingres√° capacidad");

    const res = await fetch(`${API}/camion?capacidad=${cap}`, { method: "POST" });
    document.getElementById("msgCrearCamion").innerText = await res.text();
  });


  // === CARGAR CAMIONES ===
  async function cargarCamiones() {
    try {
      const res = await fetch(`${API}/camion/list`);
      const camiones = await res.json();

      const selectCamion = document.getElementById("selectCamion");
      selectCamion.innerHTML = '<option disabled selected>Seleccionar cami√≥n</option>';

      camiones.forEach(c => {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = c.texto;

        // üîπ Extraer capacidad y carga actual del texto del toString()
        const match = c.texto.match(/(\d+)\s*\|\s*(\d+(?:\.\d+)?)\/(\d+(?:\.\d+)?)kg/);
        if (match) {
          const [, id, cargaActual, capacidad] = match;
          option.dataset.carga = parseFloat(cargaActual);
          option.dataset.cap = parseFloat(capacidad);
        }



        selectCamion.appendChild(option);
      });

    } catch (err) {
      console.error("Error cargando camiones:", err);
    }
  }

  cargarCamiones();

  // === CARGA AUTOM√ÅTICA (Knapsack) ===
  document.getElementById("btnAutomatico").addEventListener("click", async () => {
    const selectCamion = document.getElementById("selectCamion");
    const msgCarga = document.getElementById("msgCarga");

    if (!selectCamion.value) {
      alert("Seleccion√° un cami√≥n antes de cargarlo.");
      return;
    }

    const camionId = selectCamion.value; // ‚úÖ Ahora ya es el n√∫mero limpio

    msgCarga.innerText = "‚è≥ Cargando cami√≥n de forma √≥ptima...";

    try {
      const res = await fetch(`${API}/camion/cargar?camionId=${camionId}`, {
        method: "POST",
      });

      const texto = await res.text();
      msgCarga.innerText = texto;
      cargarCamiones(); // refrescar
    } catch (err) {
      console.error("Error cargando cami√≥n:", err);
      msgCarga.innerText = "‚ùå Error al cargar el cami√≥n.";
    }
  });

  document.getElementById("btnManual").addEventListener("click", async () => {
    const selectCamion = document.getElementById("selectCamion");
    if (!selectCamion.value) return alert("Seleccion√° un cami√≥n");

    const camionId = selectCamion.value;
    const capacidad = parseFloat(selectCamion.selectedOptions[0].dataset.cap);
    let cargaActual = parseFloat(selectCamion.selectedOptions[0].dataset.carga);

    // üì¶ Obtener paquetes ordenados
    const res = await fetch(`${API}/paquetes/sort`, { method: "POST" });
    const paquetes = await res.json();

    const contenedor = document.getElementById("listaPaquetes");
    const pesoRestante = document.getElementById("pesoRestante");
    const btnConfirmar = document.getElementById("btnConfirmarManual");

    contenedor.innerHTML = "";
    let seleccionados = [];

    const actualizarPeso = () => {
      const totalSeleccionado = seleccionados.reduce((s, p) => s + p.peso, 0);
      console.log("capacidad:", capacidad, "cargaActual:", cargaActual, "totalSeleccionado:", totalSeleccionado);      const restante = capacidad - (cargaActual + totalSeleccionado);
      pesoRestante.innerText = `${restante.toFixed(2)} kg`;
      pesoRestante.style.color = restante < 0 ? "red" : "green";
      btnConfirmar.disabled = restante < 0;
    };

    // üîπ Render din√°mico a partir del Map
    for (const p of paquetes.sort((a, b) => a.peso - b.peso)) {
      // Llamamos a tu endpoint para obtener el texto formateado
      const textoRes = await fetch(`${API}/paquete/aTexto?ID=${p.id}`);
      const texto = await textoRes.text();

      const div = document.createElement("div");
      div.innerHTML = `
    <input type="checkbox" id="p${p.id}" data-id="${p.id}" data-peso="${p.peso}">
    <label for="p${p.id}">${texto}</label>
  `;
      contenedor.appendChild(div);

      div.querySelector("input").addEventListener("change", e => {
        const idSel = parseInt(e.target.dataset.id);
        const pesoSel = parseFloat(e.target.dataset.peso);

        if (e.target.checked) {
          seleccionados.push({ id: idSel, peso: pesoSel });
        } else {
          seleccionados = seleccionados.filter(x => x.id !== idSel);
        }
        actualizarPeso();
      });
    }

    // üîπ Confirmar carga
    btnConfirmar.onclick = async () => {
      if (seleccionados.length === 0) {
        alert("Seleccion√° al menos un paquete.");
        return;
      }

      const body = {
        id: camionId,
        paquetes: seleccionados.map(x => x.id)
      };

      const res = await fetch(`${API}/camion/cargarManual`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const msg = await res.text();
      document.getElementById("msgCarga").innerText = msg;
      contenedor.innerHTML = "";
      pesoRestante.innerText = "";
    };

    actualizarPeso();
    document.getElementById("cargaManual").style.display = "block";
  });





</script>

</body>
</html>
