<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carga de Camiones - Log√≠sticas PEPE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>.loader { display:none; width:50px; }</style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">‚Üê Volver | Log√≠sticas PEPE</a>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="text-center mb-4">üöö Cargar Camiones</h2>
  <p class="text-center text-muted mb-4">Capacidad fija por cami√≥n: <b>1000 kg</b></p>

  <!-- Form simple: un paquete por vez -->
  <div class="card mb-4">
    <div class="card-header bg-dark text-white">Nuevo paquete</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Peso (kg)</label>
          <input type="number" id="pesoPaquete" class="form-control" placeholder="Ej: 120" min="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Ciudad destino</label>
          <input type="text" id="ciudadDestino" class="form-control" placeholder="Ej: Rosario" required>
        </div>
        <div class="col-md-4 d-grid gap-2">
          <button class="btn btn-success" id="btnDP">Carga autom√°tica (Prog. Din√°mica)</button>
          <button class="btn btn-warning" id="btnDyV">Carga manual (Divide y vencer√°s)</button>
        </div>
      </div>
      <div class="mt-2 small text-muted">Se crear√°n camiones autom√°ticamente si no entra en los existentes.</div>
    </div>
  </div>

  <!-- Ver mapa (DFS) muy simple -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white fw-bold">üó∫Ô∏è Ver mapa (DFS)</div>
    <div class="card-body">
      <button class="btn btn-info text-white" id="btnDFS">Mostrar recorrido desde la ciudad destino</button>
      <img id="loaderDFS" src="imgs/camionCargando.gif" class="loader ms-2" style="display:none;width:40px">
      <div id="msgDFS" class="mt-2"></div>
    </div>
  </div>

  <!-- Estado actual -->
  <div class="card">
    <div class="card-header bg-light">Estado de camiones</div>
    <div class="card-body">
      <div id="estadoCamiones" class="table-responsive"></div>
    </div>
  </div>
</div>


<script>
  const API = "http://localhost:8080/neo";

  // ======= Config =======
  const CAPACIDAD_CAMION = 1000; // <- fija (pod√©s cambiar el n√∫mero si quer√©s)

  // ======= Estado en memoria (front) =======
  let camiones = []; // [{id, carga, capacidad, paquetes:[{peso, ciudad}]}]
  let nextId = 1;

  const pesoEl = document.getElementById("pesoPaquete");
  const ciudadEl = document.getElementById("ciudadDestino");
  const estadoEl = document.getElementById("estadoCamiones");

  function crearCamion() {
    const nuevo = { id: nextId++, carga: 0, capacidad: CAPACIDAD_CAMION, paquetes: [] };
    camiones.push(nuevo);
    return nuevo;
  }

  function render() {
    if (camiones.length === 0) {
      estadoEl.innerHTML = `<div class="text-muted">No hay camiones cargados todav√≠a.</div>`;
      return;
    }
    let html = `
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>#</th><th>Carga usada</th><th>Capacidad</th><th>Restante</th><th>Paquetes</th>
          </tr>
        </thead>
        <tbody>
          ${camiones.map(c => `
            <tr>
              <td>Cami√≥n ${c.id}</td>
              <td>${c.carga} kg</td>
              <td>${c.capacidad} kg</td>
              <td>${c.capacidad - c.carga} kg</td>
              <td>${c.paquetes.map(p => `${p.peso}kg‚Üí${p.ciudad}`).join(", ") || "-"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
    estadoEl.innerHTML = html;
  }

  function leerInputs() {
    const peso = Number(pesoEl.value);
    const ciudad = (ciudadEl.value || "").trim();
    if (!peso || peso <= 0 || !ciudad) return null;
    return { peso, ciudad };
  }

  // ======= Heur√≠sticas simples =======
  // DP (mock): Best-Fit -> el cami√≥n con MENOR espacio sobrante donde entra
  function colocarDP(paquete) {
    let mejor = null;
    let mejorSobrante = Infinity;
    for (const c of camiones) {
      const sobrante = c.capacidad - (c.carga + paquete.peso);
      if (sobrante >= 0 && sobrante < mejorSobrante) {
        mejor = c; mejorSobrante = sobrante;
      }
    }
    if (!mejor) mejor = crearCamion();
    mejor.paquetes.push(paquete);
    mejor.carga += paquete.peso;
  }

  // Divide y vencer√°s (mock): First-Fit -> primer cami√≥n donde entra
  function colocarDyV(paquete) {
    for (const c of camiones) {
      if (c.carga + paquete.peso <= c.capacidad) {
        c.paquetes.push(paquete);
        c.carga += paquete.peso;
        return;
      }
    }
    const nuevo = crearCamion();
    nuevo.paquetes.push(paquete);
    nuevo.carga += paquete.peso;
  }

  // ======= Botones =======
  document.getElementById("btnDP").addEventListener("click", () => {
    const data = leerInputs();
    if (!data) return alert("Complet√° peso y ciudad.");
    colocarDP(data);
    pesoEl.value = ""; ciudadEl.value = "";
    render();
  });

  document.getElementById("btnDyV").addEventListener("click", () => {
    const data = leerInputs();
    if (!data) return alert("Complet√° peso y ciudad.");
    colocarDyV(data);
    pesoEl.value = ""; ciudadEl.value = "";
    render();
  });

  // DFS ‚Äúpor arriba‚Äù: muestra recorrido desde la ciudad destino
  document.getElementById("btnDFS").addEventListener("click", async () => {
    const ciudad = (ciudadEl.value || "").trim();
    if (!ciudad) return alert("Ingres√° una ciudad destino.");
    const loader = document.getElementById("loaderDFS");
    const msg = document.getElementById("msgDFS");
    loader.style.display = "inline-block";
    msg.innerHTML = "";
    try {
      const res = await fetch(`${API}/grafo/dfs?inicio=${encodeURIComponent(ciudad)}`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      msg.innerHTML = `Recorrido DFS desde <b>${ciudad}</b>: ${data.join(" ‚Üí ")}`;
    } catch {
      msg.innerHTML = "‚ö†Ô∏è Ejemplo (mock): CiudadX ‚Üí CiudadY ‚Üí CiudadZ";
    } finally {
      loader.style.display = "none";
    }
  });

  // Estado inicial
  render();
</script>

</body>
</html>
