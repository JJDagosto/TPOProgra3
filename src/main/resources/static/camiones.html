<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cargar Camiones - Log√≠sticas PEPE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .loader { width: 40px; display:none }
    .overload { background-color: #ffb3b3; }
    .btn-full { width:100%; }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">‚Üê Volver | Log√≠sticas PEPE</a>
  </div>
</nav>

<div class="container mt-5">
  <h2 class="text-center mb-4">üöö Gesti√≥n de Camiones</h2>

  <!-- =================== CREAR PAQUETE =================== -->
  <div class="card mb-4" id="crear-paquete">
    <div class="card-header bg-primary text-white">üì¶ Crear Paquete</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <input type="number" id="pesoPaquete" class="form-control" placeholder="Peso (kg)">
        </div>
        <div class="col-md-3">
          <select id="origenPaquete" class="form-select">
            <option selected disabled>Seleccionar origen</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="destinoPaquete" class="form-select" disabled>
            <option selected disabled>Seleccionar destino</option>
          </select>
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary btn-full" id="btnCrearPaquete">Crear Paquete</button>
        </div>
      </div>
      <div id="msgCrearPaquete" class="mt-2 text-success"></div>
    </div>
  </div>

  <!-- =================== CREAR CAMION =================== -->
  <div class="card mb-4" id="crear-camion">
    <div class="card-header bg-success text-white">üöõ Crear Cami√≥n</div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <input type="number" id="capacidadCamion" class="form-control" placeholder="Capacidad (kg)">
        </div>
        <div class="col-md-4">
          <button class="btn btn-success btn-full" id="btnCrearCamion">Crear Cami√≥n</button>
        </div>
      </div>
      <div id="msgCrearCamion" class="mt-2 text-success"></div>
    </div>
  </div>

  <!-- =================== CARGAR CAMIONES =================== -->
  <div class="card mb-4" id="cargar-camiones">
    <div class="card-header bg-secondary text-white">üîß Cargar Camiones</div>
    <div class="card-body">

      <p class="fw-bold">1) Eleg√≠ un cami√≥n:</p>
      <select id="selectCamion" class="form-select mb-3"></select>

      <div class="row g-3">
        <div class="col-md-6">
          <button class="btn btn-dark btn-full" id="btnManual">Carga Manual</button>
        </div>
        <div class="col-md-6">
          <button class="btn btn-info btn-full text-white" id="btnAutomatico">Carga Autom√°tica</button>
        </div>
      </div>

      <div id="msgCarga" class="mt-3 fw-bold"></div>

      <!-- PANEL MANUAL -->
      <div id="cargaManual" class="mt-4" style="display:none;">
        <hr>
        <h5>Seleccion√° paquetes:</h5>
        <p>Peso restante: <b id="pesoRestante"></b> kg</p>

        <div id="listaPaquetes" class="mt-3"></div>

        <button class="btn btn-success mt-3 btn-full" id="btnConfirmarManual">Confirmar Carga</button>
      </div>

    </div>
  </div>
</div>



<script>
  const API = "http://localhost:8080/neo";
  let paquetes = [];
  let capacidad = 0;
  let cargaActual = 0;
  let seleccionados = [];

  const selectCamion = document.getElementById("selectCamion");
  const pesoRestanteEl = document.getElementById("pesoRestante");
  const listaPaquetesEl = document.getElementById("listaPaquetes");
  const msgCarga = document.getElementById("msgCarga");

  // Cargar camiones
  async function cargarCamionesSelect() {
    const res = await fetch(`${API}/camion`);
    const data = await res.json();

    selectCamion.innerHTML = data.length === 0
            ? `<option disabled selected>No hay camiones creados</option>`
            : data.map(c => `<option value="${c.id}" data-cap="${c.capacidad}" data-carga="${c.cargaActual}">
        Cami√≥n ${c.id} - ${c.cargaActual}/${c.capacidad} kg
      </option>`).join("");
  }
  cargarCamionesSelect();

  // Crear paquete
  document.getElementById("btnCrearPaquete").addEventListener("click", async () => {
    const peso = pesoPaquete.value;
    const origen = origenPaquete.value;
    const destino = destinoPaquete.value;
    if (!peso || !origen || !destino) return alert("Complet√° los datos");

    const res = await fetch(`${API}/paquete?peso=${peso}&origen=${origen}&destino=${destino}`, { method:"POST" });
    document.getElementById("msgCrearPaquete").innerText = await res.text();
    pesoPaquete.value=""; destinoPaquete.value=""; origenPaquete.value="";
  });

  // Crear cami√≥n
  document.getElementById("btnCrearCamion").addEventListener("click", async () => {
    const cap = capacidadCamion.value;
    if (!cap) return alert("Ingres√° capacidad");
    const res = await fetch(`${API}/camion?capacidad=${cap}`, { method:"POST" });
    document.getElementById("msgCrearCamion").innerText = await res.text();
    capacidadCamion.value="";
    cargarCamionesSelect();
  });

  // Carga Manual
  document.getElementById("btnManual").addEventListener("click", async () => {
    if (!selectCamion.value) return alert("Seleccion√° cami√≥n");

    capacidad = Number(selectCamion.selectedOptions[0].dataset.cap);
    cargaActual = Number(selectCamion.selectedOptions[0].dataset.carga);
    seleccionados = [];

    const res = await fetch(`${API}/paquetes/sort`);
    paquetes = await res.json();

    renderPaquetes();
    actualizarPesoRestante();
    cargaManual.style.display="block";
  });

  function renderPaquetes() {
    listaPaquetesEl.innerHTML = paquetes.map(p => `
    <div>
      <input type="checkbox" class="chk" data-id="${p.id}" data-peso="${p.peso}">
      ${p.peso}kg - ${p.origen.nombre} ‚Üí ${p.destino.nombre}
    </div>
  `).join("");

    document.querySelectorAll(".chk").forEach(chk => {
      chk.addEventListener("change", () => {
        const peso = Number(chk.dataset.peso);

        if (chk.checked) {
          cargaActual += peso;
          seleccionados.push(Number(chk.dataset.id));
        } else {
          cargaActual -= peso;
          seleccionados = seleccionados.filter(id => id !== Number(chk.dataset.id));
        }

        actualizarPesoRestante();
      });
    });
  }

  function actualizarPesoRestante() {
    const restante = capacidad - cargaActual;
    pesoRestanteEl.innerText = restante;
    pesoRestanteEl.classList.toggle("text-danger", restante < 0);
    listaPaquetesEl.classList.toggle("overload", restante < 0);
  }

  // Confirmar manual
  document.getElementById("btnConfirmarManual").addEventListener("click", async () => {
    if (capacidad - cargaActual < 0) {
      alert("Te pasaste del peso, deseleccion√° paquetes.");
      return;
    }
    const camionId = selectCamion.value;

    const body = {
      id: camionId,
      capacidad: capacidad,
      cargaActual: cargaActual,
      paquetes: seleccionados.map(id => ({ id }))
    };

    const res = await fetch(`${API}/camion/cargarManual`, {
      method: "PUT",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    msgCarga.innerText = await res.text();

    // ELIMINAR paquetes cargados
    for (const id of seleccionados) {
      await fetch(`${API}/paquete/${id}`, { method:"DELETE" });
    }

    cargaManual.style.display="none";
    cargarCamionesSelect();
  });

  // Autom√°tico
  document.getElementById("btnAutomatico").addEventListener("click", async () => {
    if (!selectCamion.value) return alert("Seleccion√° cami√≥n");

    const camionId = selectCamion.value;
    const res = await fetch(`${API}/camion/cargar?camionId=${camionId}`, { method:"POST" });
    msgCarga.innerText = await res.text();

    // eliminar paquetes cargados por DP
    const resPaquetes = await fetch(`${API}/paquetes/sort`);
    const paqs = await resPaquetes.json();
    for (const p of paqs) {
      if (p.cargado === true) await fetch(`${API}/paquete/${p.id}`, {method:"DELETE"});
    }

    cargarCamionesSelect();
  });
</script>
</body>
</html>
