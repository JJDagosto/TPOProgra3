<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DFS Visual - Log√≠sticas PEPE</title>

    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #e8f5e9;
            text-align: center;
        }
        #network {
            width: 100%;
            height: 700px;
            border: 2px solid #2e7d32;
            border-radius: 12px;
            background: #ffffff;
            margin-top: 20px;
        }
        button, select {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            background: #2e7d32;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover { background: #1b5e20; }
    </style>
</head>
<body>

<h2>üåç Visualizaci√≥n del Recorrido DFS</h2>

<select id="selectCiudad">
    <option disabled selected>Elegir ciudad inicio...</option>
</select>

<button onclick="cargarDFS()">üöÄ Ejecutar DFS</button>

<div id="network"></div>

<script>
    const API = "http://localhost:8080/neo";

    // Cargar ciudades en el select
    async function cargarCiudades() {
        const res = await fetch(`${API}/ciudad/get/nombres`);
        const data = await res.json();

        const sel = document.getElementById("selectCiudad");
        data.forEach(c => {
            let opt = document.createElement("option");
            opt.value = c;
            opt.textContent = c;
            sel.appendChild(opt);
        });
    }
    cargarCiudades();

    async function cargarDFS() {
        const origen = document.getElementById("selectCiudad").value;
        if (!origen) {
            alert("‚ö†Ô∏è Eleg√≠ una ciudad");
            return;
        }

        const res = await fetch(`${API}/grafo/dfs?inicio=${encodeURIComponent(origen)}`);
        const recorrido = await res.json();

        if (!Array.isArray(recorrido) || recorrido.length < 2) {
            alert("‚ùå No hay rutas para esta ciudad");
            return;
        }

        // --- Creamos nodos con imagen ---
        const nodes = recorrido.map(ciudad => ({
            id: ciudad,
            label: ciudad,
            shape: "image",
            image: "imgs/ciudad.gif",
            size: 55,
            font: {
                color: "#1b5e20",
                size: 16,
                vadjust: 25,
                bold: true
            }
        }));

        // --- Creamos aristas (solo entre cada ciudad consecutiva del DFS) ---
        let edges = [];
        for (let i = 1; i < recorrido.length; i++) {
            edges.push({
                from: recorrido[i - 1],
                to: recorrido[i],
                label: "",
                smooth: { type: "cubicBezier" },
                color: { color: "transparent" },
                width: 1
            });
        }

        const container = document.getElementById("network");
        const dataNet = {
            nodes: new vis.DataSet(nodes),
            edges: new vis.DataSet(edges)
        };

        const options = {
            physics: { barnesHut: { gravitationalConstant: -7000 } },
            interaction: { dragNodes: true, zoomView: true },
            edges: { arrows: { to: false } }
        };

        const network = new vis.Network(container, dataNet, options);

        // ‚úÖ Dibujar carreteras con ruta.png
        const roadImg = new Image();
        roadImg.src = "imgs/ruta.png";

        function dibujarRuta(ctx, p1, p2) {
            const dx = p2.x - p1.x;
            const dy = p2.y - p1.y;
            const len = Math.hypot(dx, dy);
            const step = 40;
            const scale = 0.15;
            const angle = Math.atan2(dy, dx);

            let t = 0;
            while (t <= len) {
                const x = p1.x + (dx / len) * t;
                const y = p1.y + (dy / len) * t;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                ctx.drawImage(roadImg, -15, -15, roadImg.width * scale, roadImg.height * scale);
                ctx.restore();
                t += step;
            }
        }

        roadImg.onload = () => {
            network.on("beforeDrawing", ctx => {
                for (let i = 1; i < recorrido.length; i++) {
                    const p1 = network.getPositions([recorrido[i - 1]])[recorrido[i - 1]];
                    const p2 = network.getPositions([recorrido[i]])[recorrido[i]];
                    if (p1 && p2) dibujarRuta(ctx, p1, p2);
                }
            });
            network.redraw();
        };

        alert("‚úÖ DFS completado. Ciudades visitadas: " + recorrido.length);
    }
</script>

</body>
</html>
