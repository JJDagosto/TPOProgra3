<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Kruskal Visual - Log√≠sticas PEPE</title>
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0fdf4;
            text-align: center;
        }
        #network {
            width: 100%;
            height: 700px;
            border: 2px solid #4caf50;
            border-radius: 12px;
            background: #ffffff;
            margin-top: 20px;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            border: none;
            background: #4caf50;
            color: white;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        button:hover {
            background: #43a047;
        }
    </style>
</head>
<body>

<h2>üõ£Ô∏è Visualizaci√≥n del √Årbol M√≠nimo - Kruskal</h2>
<button onclick="cargarKruskal()">üöÄ Calcular MST</button>

<div id="network"></div>

<script>
    async function cargarKruskal() {
        const res = await fetch("http://localhost:8080/neo/grafo/kruskal");
        const data = await res.json();

        // Crear nodos con imagen ciudad.gif
        const nodosSet = new Set();
        data.aristas.forEach(a => {
            nodosSet.add(a.origen);
            nodosSet.add(a.destino);
        });

        const nodes = Array.from(nodosSet).map(nombre => ({
            id: nombre,
            label: nombre,
            shape: "image",
            image: "imgs/ciudad.gif",
            size: 60,
            font: {
                color: "#1b5e20",
                size: 18,
                vadjust: 25,  // üîπ antes era 45, m√°s cerca ahora
                face: "Arial",
                bold: true
            }
        }));

        const edges = data.aristas.map(a => ({
            from: a.origen,
            to: a.destino,
            label: a.peso + " km",
            font: { align: "top", size: 14 },
            color: { color: "transparent" },
            width: 1,
            smooth: { type: "cubicBezier", forceDirection: "none" }
        }));

        const container = document.getElementById("network");
        const networkData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

        const options = {
            physics: { barnesHut: { gravitationalConstant: -7000 } },
            interaction: { dragNodes: true, zoomView: true },
            edges: { arrows: { to: false } },
            layout: { improvedLayout: true }
        };

        const network = new vis.Network(container, networkData, options);

        // üîπ Cargamos la textura de la ruta
        const roadImg = new Image();
        roadImg.src = "imgs/ruta.png";

        // Funci√≥n para dibujar las carreteras repetidas
        function drawRoadSprites(ctx, fromPos, toPos) {
            const dx = toPos.x - fromPos.x;
            const dy = toPos.y - fromPos.y;
            const len = Math.hypot(dx, dy);
            const step = 40;      // distancia entre m√≥dulos
            const scale = 0.15;   // escala de la imagen
            const angle = Math.atan2(dy, dx);
            const ux = dx / len, uy = dy / len;

            let t = 0;
            while (t <= len) {
                const x = fromPos.x + ux * t;
                const y = fromPos.y + uy * t;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(angle);
                const w = roadImg.width * scale;
                const h = roadImg.height * scale;
                ctx.drawImage(roadImg, -w / 2, -h / 2, w, h);
                ctx.restore();

                t += step;
            }
        }

        // ‚ö° Dibujamos las calles antes de los nodos
        roadImg.onload = function () {
            network.on("beforeDrawing", function (ctx) {
                data.aristas.forEach(a => {
                    const p1 = network.getPositions([a.origen])[a.origen];
                    const p2 = network.getPositions([a.destino])[a.destino];
                    if (p1 && p2) drawRoadSprites(ctx, p1, p2);
                });
            });
            network.redraw();
        };

        alert("‚úÖ √Årbol m√≠nimo cargado. Peso total: " + data.pesoTotal + " km");
    }
</script>

</body>
</html>
