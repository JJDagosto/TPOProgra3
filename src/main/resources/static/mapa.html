<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizar Mapa - Log√≠sticas PEPE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* ==== ANIMACIONES ==== */



        .linea {
            position: absolute;
            height: 4px;
            background: #333;
            border-radius: 4px;
            transform-origin: left center;
            transform: scaleX(0);
            transition: transform 0.8s ease-out;
        }

        #loader {
            font-size: 22px;
            text-align: center;
            margin-top: 25px;
            display: none;
        }

        #mapa {
            width: 100%;
            height: 600px;
            border: 2px solid #222;
            background: #e9ecef;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }

        .nodo {
            width: 100px;
            padding: 5px;
            border-radius: 12px;
            font-size: 13px;
            position: absolute;
            text-align: center;
            transform: translate(-50%, -50%);
            transition: transform 0.2s ease;
        }
        .nodo:hover {
            transform: translate(-50%, -50%) scale(1.08);
        }


        .nodo img {
            width: 26px;   /* Aca pones el tama√±o del PNG */
            height: 26px;
            display: block;
            margin: auto;
        }

        .nodo span {
            background: #0d6efd;
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 13px;
            display: inline-block;
            margin-top: 3px;
            transition: transform 0.2s ease;
        }

        .linea {
            position: absolute;
            height: 3px;
            background: #333;
            transform-origin: 0 0;
            border-radius: 3px;
        }

        .distancia-label {
            position: absolute;
            background: yellow;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            transform: translate(-50%, -50%);
        }

    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="index.html">‚Üê Volver | Log√≠sticas PEPE</a>
        <span class="navbar-text text-white">üó∫Ô∏è Visualizar Mapa</span>
    </div>
</nav>

<div class="container">
    <h3 class="text-center mb-3">Rutas disponibles desde una ciudad</h3>

    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <select id="selectCiudad" class="form-select">
                <option selected disabled>Elegir ciudad...</option>
            </select>
        </div>
        <div class="col-md-6">
            <button id="btnMostrar" class="btn btn-primary w-100">Mostrar mapa</button>
        </div>
    </div>

    <div id="loader">‚è≥ Calculando rutas...</div>
    <div id="mapa" style="position:relative; width:100%; height:400px; border:1px solid #ddd;"></div>


</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const API = "http://localhost:8080/neo";

        // ===== Refs del DOM =====
        const selectCiudad = document.getElementById("selectCiudad"); // <select id="selectCiudad">
        const btnMostrar   = document.getElementById("btnMostrar");   // <button id="btnMostrar">
        const mapa         = document.getElementById("mapa");         // <div id="mapa">
        const loader       = document.getElementById("loader");       // <div id="loader">

        // ===== Cargar ciudades en el <select> =====
        async function cargarCiudades() {
            try {
                const res = await fetch(`${API}/ciudad/get/nombres`, { cache: "no-store" });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const data = await res.json();

                // limpiar y placeholder
                selectCiudad.innerHTML = "";
                const ph = document.createElement("option");
                ph.disabled = true; ph.selected = true;
                ph.textContent = "Elegir ciudad...";
                selectCiudad.appendChild(ph);

                // opciones
                data.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c;
                    opt.textContent = c;
                    selectCiudad.appendChild(opt);
                });
            } catch (e) {
                console.error("Error cargando ciudades:", e);
                selectCiudad.innerHTML = "";
                const err = document.createElement("option");
                err.disabled = true; err.selected = true;
                err.textContent = "Error al cargar ciudades";
                selectCiudad.appendChild(err);
            }
        }
        cargarCiudades();

        // ===== Mostrar mapa (DFS) =====
        btnMostrar.addEventListener("click", async () => {
            const origen = selectCiudad.value;
            if (!origen || selectCiudad.selectedIndex === 0) {
                alert("Eleg√≠ una ciudad");
                return;
            }

            mapa.innerHTML = "";
            loader.style.display = "block";

            const ancho = mapa.clientWidth || 800;
            const alto  = mapa.clientHeight || 300;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", ancho);
            svg.setAttribute("height", alto);
            svg.style.position = "absolute";
            svg.style.left = "0";
            svg.style.top = "0";
            svg.style.zIndex = "9000";
            mapa.appendChild(svg);

            try {
                const res = await fetch(`${API}/grafo/dfs?inicio=${encodeURIComponent(origen)}`, { cache: "no-store" });
                if (!res.ok) throw new Error("HTTP " + res.status);
                const recorrido = await res.json();

                loader.style.display = "none";

                if (!Array.isArray(recorrido) || recorrido.length < 2) {
                    mapa.innerHTML = "<h5 class='text-center mt-4'>No hay rutas desde esta ciudad</h5>";
                    return;
                }

                const nodosPos = {};

                // ==== Distribuci√≥n serpentina (zig-zag) en 4 filas ====
                const total = recorrido.length;
                const filas = 4;
                const nodosPorFila = Math.ceil(total / filas);

                for (let i = 0; i < total; i++) {
                    const ciudad = recorrido[i];

                    // fila a la que pertenece
                    const fila = Math.floor(i / nodosPorFila);

                    // √≠ndice dentro de esa fila
                    let posEnFila = i % nodosPorFila;

                    // SERPENTINA: si la fila es impar, invertimos el orden en X
                    if (fila % 2 === 1) {
                        posEnFila = (nodosPorFila - 1) - posEnFila;
                    }

                    const x = (ancho / (nodosPorFila + 1)) * (posEnFila + 1);

                    // posici√≥n vertical seg√∫n fila
                    let y;
                    if (fila === 0) y = alto * 0.22;
                    if (fila === 1) y = alto * 0.42;
                    if (fila === 2) y = alto * 0.62;
                    if (fila === 3) y = alto * 0.82;

                    nodosPos[ciudad] = { x, y };
                    crearNodo(ciudad, x, y);
                }



                function crearNodo(ciudad, x, y) {
                    const div = document.createElement("div");
                    div.className = "nodo";
                    div.style.left = x + "px";
                    div.style.top  = y + "px";
                    div.style.position = "absolute";
                    div.style.zIndex = "9999";
                    div.style.transform = "translate(-50%, -50%)";
                    div.style.display = "flex";
                    div.style.flexDirection = "column";
                    div.style.alignItems = "center";
                    div.style.gap = "4px";
                    div.style.background = "rgba(255,255,255,0.9)";
                    div.style.border = "1px solid #333";
                    div.style.padding = "3px";
                    div.style.borderRadius = "8px";
                    div.style.fontSize = "12px";
                    div.style.width = "110px";     // ancho fijo
                    div.style.textAlign = "center";
                    div.style.whiteSpace = "normal";  // permite salto de l√≠nea
                    div.style.wordWrap = "break-word"; // corta palabras largas

                    div.innerHTML = `
        <img src="imgs/ubicaciones.png" width="40" height="40" alt="Ciudad">
        <span>${ciudad}</span>
    `;

                    mapa.appendChild(div);
                }



                // L√≠neas + etiquetas de distancia
                for (let i = 1; i < recorrido.length; i++) {

                    const c1 = recorrido[i - 1];
                    const c2 = recorrido[i];

                    // distancia
                    let textoDist = "?? km";
                    try {
                        const rd = await fetch(`${API}/ruta/distancia?origen=${encodeURIComponent(c1)}&destino=${encodeURIComponent(c2)}`, { cache: "no-store" });
                        if (rd.ok) {
                            const dist = await rd.json();
                            if (typeof dist === "number") textoDist = `${dist} km`;
                        }
                    } catch {}

                    const p1 = nodosPos[c1];
                    const p2 = nodosPos[c2];

                    const dx = p2.x - p1.x;
                    const dy = p2.y - p1.y;
                    const largo  = Math.sqrt(dx*dx + dy*dy);
                    const angulo = Math.atan2(dy, dx) * (180 / Math.PI);

                    // ==== L√çNEA ====
                    const curva = document.createElementNS("http://www.w3.org/2000/svg", "path");

// punto de inicio
                    const x1 = p1.x;
                    const y1 = p1.y;

// punto final
                    const x2 = p2.x;
                    const y2 = p2.y;

// ‚úÖ control para que la curva sea suave y salga del borde del nodo
                    const curvaAltura = 60; // m√°s grande = arco m√°s pronunciado
                    const cx = (x1 + x2) / 2;        // mitad del camino
                    const cy = ((y1 + y2) / 2) - curvaAltura; // sube para hacer la curva convexa

// path Bezier: M start, Q controlPoint, end
                    const pathData = `M ${x1} ${y1} Q ${cx} ${cy} ${x2} ${y2}`;

                    curva.setAttribute("d", pathData);
                    curva.setAttribute("stroke", "#333");
                    curva.setAttribute("fill", "transparent");
                    curva.setAttribute("stroke-width", "3");
                    curva.style.zIndex = "9000";

// animaci√≥n de curva "dibuj√°ndose"
                    curva.style.strokeDasharray = "1000";
                    curva.style.strokeDashoffset = "1000";
                    curva.style.transition = "stroke-dashoffset 0.8s ease-out";

                    svg.appendChild(curva);

// dispara animaci√≥n
                    requestAnimationFrame(() => {
                        curva.style.strokeDashoffset = "0";
                    });


                    // ==== ETIQUETA DE DISTANCIA EN LA PARTE CONVEXA ====
                    const label = document.createElement("div");
                    label.className = "distancia-label";
                    label.textContent = textoDist;

                    label.style.position = "absolute";
                    label.style.left = cx + "px";      // usamos el control de la curva
                    label.style.top  = (cy - 10) + "px";  // un poquito arriba para que se vea
                    label.style.zIndex = "9995";

                    mapa.appendChild(label);

                }

            } catch (e) {
                console.error(e);
                loader.style.display = "none";
                mapa.innerHTML = "<h5 class='text-center mt-4'>No se pudo calcular el mapa</h5>";
            }
        });

    });
</script>

</body>
</html>
