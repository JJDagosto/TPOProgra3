<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>BFS Visual - Log√≠sticas PEPE</title>

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">

  <style>
    body { font-family: Arial, sans-serif; background: #fff7e6; text-align: center; }
    #network {
      width: 100%;
      height: 700px;
      border: 2px solid #ffa726;
      border-radius: 12px;
      background: white;
      margin-top: 20px;
    }
    button, select {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #ffa726;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #fb8c00; }
  </style>
</head>
<body>

<h2>üîç Visualizaci√≥n BFS - Log√≠sticas PEPE</h2>

<select id="selectCiudad">
  <option disabled selected>Elegir ciudad inicio...</option>
</select>

<br>
<button onclick="cargarBFS()">üöÄ Ejecutar BFS</button>

<div id="network"></div>

<script>
  const API = "http://localhost:8080/neo";

  // ‚úÖ Cargar ciudades en el select
  async function cargarCiudades() {
    const res = await fetch(`${API}/ciudad/get/nombres`);
    const data = await res.json();

    const sel = document.getElementById("selectCiudad");
    data.forEach(c => {
      let opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }
  cargarCiudades();

  async function cargarBFS() {
    const inicio = document.getElementById("selectCiudad").value;
    if (!inicio) {
      alert("‚ö†Ô∏è Eleg√≠ una ciudad");
      return;
    }

    // ‚úÖ El backend devuelve SOLO una lista con el recorrido
    const res = await fetch(`${API}/grafo/bfs?inicio=${encodeURIComponent(inicio)}`);
    const recorrido = await res.json();

    if (!Array.isArray(recorrido) || recorrido.length < 2) {
      alert("‚ùå BFS no puede recorrer el grafo desde esta ciudad.");
      return;
    }

    // ‚úÖ Crear nodos
    const nodes = recorrido.map(ciudad => ({
      id: ciudad,
      label: ciudad,
      shape: "image",
      image: "imgs/ciudad.gif",
      size: 55,
      font: { color: "#ef6c00", size: 18, bold: true, face: "Arial", vadjust: 25 }
    }));

    // ‚úÖ Crear aristas entre cada par consecutivo
    const edges = [];
    for (let i = 1; i < recorrido.length; i++) {
      edges.push({
        from: recorrido[i - 1],
        to: recorrido[i],
        color: { color: "transparent" },
        width: 2,
        smooth: { type: "cubicBezier" }
      });
    }

    const container = document.getElementById("network");
    const networkData = {
      nodes: new vis.DataSet(nodes),
      edges: new vis.DataSet(edges)
    };

    const options = {
      physics: { barnesHut: { gravitationalConstant: -7500 } },
      interaction: { dragNodes: true, zoomView: true },
      edges: { arrows: { to: false } }
    };

    const network = new vis.Network(container, networkData, options);

    // ‚úÖ Dibujar caminos con ruta.png
    const roadImg = new Image();
    roadImg.src = "imgs/ruta.png";

    function drawRoadSprites(ctx, p1, p2) {
      const dx = p2.x - p1.x, dy = p2.y - p1.y;
      const len = Math.hypot(dx, dy);
      const step = 40, scale = 0.15;
      const angle = Math.atan2(dy, dx);

      for (let t = 0; t <= len; t += step) {
        ctx.save();
        ctx.translate(p1.x + (dx / len) * t, p1.y + (dy / len) * t);
        ctx.rotate(angle);
        ctx.drawImage(roadImg, -roadImg.width * scale / 2, -roadImg.height * scale / 2,
                roadImg.width * scale, roadImg.height * scale);
        ctx.restore();
      }
    }

    roadImg.onload = () => {
      network.on("beforeDrawing", ctx => {
        for (let i = 1; i < recorrido.length; i++) {
          const p1 = network.getPositions([recorrido[i - 1]])[recorrido[i - 1]];
          const p2 = network.getPositions([recorrido[i]])[recorrido[i]];
          if (p1 && p2) drawRoadSprites(ctx, p1, p2);
        }
      });
      network.redraw();
    };

    alert("‚úÖ BFS completado:\n" + recorrido.join(" ‚Üí "));
  }
</script>

</body>
</html>
