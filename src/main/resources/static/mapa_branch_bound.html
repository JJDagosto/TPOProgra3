<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Branch & Bound - Log√≠sticas PEPE</title>

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff0f5;
      text-align: center;
    }
    #network {
      width: 100%;
      height: 700px;
      border: 2px solid #d81b60;
      border-radius: 12px;
      background: #ffffff;
      margin-top: 20px;
    }
    button, input, select {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      background: #d81b60;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #ad1457;
    }
  </style>
</head>
<body>

<h2>üß† Optimizaci√≥n Branch & Bound</h2>
<p>Encontr√° la ruta m√°s larga posible sin superar una distancia m√°xima.</p>

<select id="selectCiudad">
  <option disabled selected>Elegir ciudad inicio...</option>
</select>

<br>

<input id="maxDistancia" type="number" placeholder="Distancia m√°xima (km)" min="1">

<br>

<button onclick="cargarBranch()">üöÄ Optimizar Ruta</button>

<div id="network"></div>

<script>
  const API = "http://localhost:8080/neo";

  // ‚úÖ Cargar ciudades en el select
  async function cargarCiudades() {
    const res = await fetch(`${API}/ciudad/get/nombres`);
    const data = await res.json();

    const sel = document.getElementById("selectCiudad");
    data.forEach(c => {
      let opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }
  cargarCiudades();

  async function cargarBranch() {
    const inicio = document.getElementById("selectCiudad").value;
    const maxDistancia = document.getElementById("maxDistancia").value;

    if (!inicio || !maxDistancia) {
      alert("‚ö†Ô∏è Eleg√≠ ciudad y distancia m√°xima.");
      return;
    }

    const res = await fetch(`${API}/grafo/branchbound?inicio=${encodeURIComponent(inicio)}&maxDistancia=${maxDistancia}`);
    const data = await res.json();

    if (!data.mejorRuta || data.mejorRuta.length < 2) {
      alert("‚ùå No se pudo generar ruta.");
      return;
    }

    // --- NODOS ---
    const nodes = data.mejorRuta.map(ciudad => ({
      id: ciudad,
      label: ciudad,
      shape: "image",
      image: "imgs/ciudad.gif",
      size: 55,
      font: {
        color: "#880e4f",
        size: 16,
        vadjust: 25,
        bold: true
      }
    }));

    // --- ARISTAS ---
    let edges = [];
    for (let i = 1; i < data.mejorRuta.length; i++) {
      edges.push({
        from: data.mejorRuta[i - 1],
        to: data.mejorRuta[i],
        color: { color: "transparent" },
        smooth: { type: "cubicBezier" },
        width: 1
      });
    }

    const network = new vis.Network(
            document.getElementById("network"),
            { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) },
            {
              physics: { barnesHut: { gravitationalConstant: -7000 } },
              interaction: { dragNodes: true, zoomView: true },
              edges: { arrows: { to: false } }
            }
    );

    // ‚úÖ Dibujar textura de ruta
    const roadImg = new Image();
    roadImg.src = "imgs/ruta.png";

    function dibujarRuta(ctx, p1, p2) {
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const len = Math.hypot(dx, dy);
      const step = 40;
      const scale = 0.15;
      const angle = Math.atan2(dy, dx);

      for (let t = 0; t <= len; t += step) {
        const x = p1.x + (dx / len) * t;
        const y = p1.y + (dy / len) * t;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        ctx.drawImage(roadImg, -15, -15, roadImg.width * scale, roadImg.height * scale);
        ctx.restore();
      }
    }

    roadImg.onload = () => {
      network.on("beforeDrawing", ctx => {
        for (let i = 1; i < data.mejorRuta.length; i++) {
          const p1 = network.getPositions([data.mejorRuta[i - 1]])[data.mejorRuta[i - 1]];
          const p2 = network.getPositions([data.mejorRuta[i]])[data.mejorRuta[i]];
          if (p1 && p2) dibujarRuta(ctx, p1, p2);
        }
      });
      network.redraw();
    };

    alert(`‚úÖ Ruta √≥ptima encontrada:
Ciudades: ${data.mejorRuta.join(" ‚Üí ")}
Distancia total: ${data.distanciaTotal} km
Ciudades visitadas: ${data.ciudadesVisitadas}`);
  }
</script>

</body>
</html>
