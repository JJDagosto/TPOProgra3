<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dijkstra - Log√≠sticas PEPE</title>

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e3f2fd;
      text-align: center;
    }
    #network {
      width: 100%;
      height: 700px;
      border: 2px solid #0288d1;
      border-radius: 12px;
      background: white;
      margin-top: 20px;
    }
    button, select {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #0288d1;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #01579b; }
  </style>
</head>
<body>

<h2>üöó Ruta m√°s corta - Dijkstra</h2>

<select id="selectOrigen">
  <option disabled selected>Origen...</option>
</select>

<select id="selectDestino">
  <option disabled selected>Destino...</option>
</select>

<button onclick="cargarDijkstra()">üöÄ Calcular ruta</button>

<div id="network"></div>

<script>
  const API = "http://localhost:8080/neo";

  // üîπ Cargar ciudades
  async function cargarCiudades() {
    const res = await fetch(`${API}/ciudad/get/nombres`);
    const data = await res.json();

    const o = document.getElementById("selectOrigen");
    const d = document.getElementById("selectDestino");

    data.forEach(c => {
      let opt1 = document.createElement("option");
      opt1.value = opt1.textContent = c;
      o.appendChild(opt1);

      let opt2 = document.createElement("option");
      opt2.value = opt2.textContent = c;
      d.appendChild(opt2);
    });
  }
  cargarCiudades();

  async function cargarDijkstra() {
    const origen = document.getElementById("selectOrigen").value;
    const destino = document.getElementById("selectDestino").value;

    if (!origen || !destino) {
      alert("‚ö†Ô∏è Eleg√≠ origen y destino");
      return;
    }

    const res = await fetch(`${API}/grafo/dijkstra?origen=${encodeURIComponent(origen)}&destino=${encodeURIComponent(destino)}`);
    const data = await res.json();

    if (!data.ruta || data.ruta.length < 2) {
      alert("‚ùå No hay ruta disponible");
      return;
    }

    // ‚úÖ Nodos
    const nodes = data.ruta.map(ciudad => ({
      id: ciudad,
      label: ciudad,
      shape: "image",
      image: "imgs/ciudad.gif",
      size: 55,
      font: { color: "#01579b", size: 16, vadjust: 25, bold: true }
    }));

    // ‚úÖ Aristas
    const edges = data.aristas.map(a => ({
      from: a.origen,
      to: a.destino,
      smooth: { type: "cubicBezier" },
      color: { color: "transparent" },
      width: 1
    }));

    const network = new vis.Network(
            document.getElementById("network"),
            { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) },
            {
              physics: { barnesHut: { gravitationalConstant: -8000 } },
              interaction: { dragNodes: true, zoomView: true },
              edges: { arrows: { to: false } }
            }
    );

    // ‚úÖ Textura de ruta
    const roadImg = new Image();
    roadImg.src = "imgs/ruta.png";

    function dibujarRuta(ctx, p1, p2) {
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const len = Math.hypot(dx, dy);
      const angle = Math.atan2(dy, dx);
      const step = 40, scale = 0.15;

      for (let t = 0; t <= len; t += step) {
        const x = p1.x + (dx / len) * t;
        const y = p1.y + (dy / len) * t;

        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        ctx.drawImage(roadImg, -15, -15, roadImg.width * scale, roadImg.height * scale);
        ctx.restore();
      }
    }

    roadImg.onload = () => {
      network.on("beforeDrawing", ctx => {
        data.aristas.forEach(a => {
          const p1 = network.getPositions([a.origen])[a.origen];
          const p2 = network.getPositions([a.destino])[a.destino];
          if (p1 && p2) dibujarRuta(ctx, p1, p2);
        });
      });
      network.redraw();
    };

    alert(`‚úÖ Ruta encontrada:
${data.ruta.join(" ‚Üí ")}
Distancia total: ${data.distanciaTotal} km`);
  }
</script>

</body>
</html>
