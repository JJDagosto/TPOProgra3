<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PRIM Visual - Log√≠sticas PEPE</title>

  <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f7ff;
      text-align: center;
    }
    #network {
      width: 100%;
      height: 700px;
      border: 2px solid #0d6efd;
      border-radius: 12px;
      background: #ffffff;
      margin-top: 20px;
    }
    button, select {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #0d6efd;
      color: white;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0b5ed7; }
  </style>
</head>
<body>

<h2>üõ£Ô∏è Visualizaci√≥n del √Årbol M√≠nimo - PRIM</h2>

<select id="selectCiudad">
  <option disabled selected>Elegir ciudad inicio...</option>
</select>

<button onclick="cargarPRIM()">üöÄ Calcular MST (Prim)</button>

<div id="network"></div>

<script>
  const API = "http://localhost:8080/neo";

  // Cargar ciudades
  async function cargarCiudades() {
    const res = await fetch(`${API}/ciudad/get/nombres`);
    const data = await res.json();

    const sel = document.getElementById("selectCiudad");
    data.forEach(c => {
      let opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }
  cargarCiudades();

  async function cargarPRIM() {
    const inicio = document.getElementById("selectCiudad").value;
    if (!inicio) {
      alert("‚ö†Ô∏è Eleg√≠ una ciudad");
      return;
    }

    const res = await fetch(`${API}/grafo/prim?inicio=${encodeURIComponent(inicio)}`);
    const data = await res.json();

    // Aristas son arrays [origen, destino, peso]
    const nodosSet = new Set();
    data.aristas.forEach(a => {
      nodosSet.add(a[0]);
      nodosSet.add(a[1]);
    });

    const nodes = Array.from(nodosSet).map(nombre => ({
      id: nombre,
      label: nombre,
      shape: "image",
      image: "imgs/ciudad.gif",
      size: 60,
      font: {
        color: "#003566",
        size: 18,
        vadjust: 25,
        face: "Arial",
        bold: true
      }
    }));

    const edges = data.aristas.map(a => ({
      from: a[0],
      to: a[1],
      label: a[2] + " km",
      font: { align: "top", size: 14 },
      color: { color: "transparent" },
      width: 1,
      smooth: { type: "cubicBezier" }
    }));

    const container = document.getElementById("network");
    const networkData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

    const options = {
      physics: { barnesHut: { gravitationalConstant: -7000 } },
      interaction: { dragNodes: true, zoomView: true },
      edges: { arrows: { to: false } }
    };

    const network = new vis.Network(container, networkData, options);

    // Dibujar ruta con textura
    const roadImg = new Image();
    roadImg.src = "imgs/ruta.png";

    function drawRoad(ctx, p1, p2) {
      const dx = p2.x - p1.x;
      const dy = p2.y - p1.y;
      const len = Math.hypot(dx, dy);
      const step = 40;
      const scale = 0.15;
      const angle = Math.atan2(dy, dx);

      for (let t = 0; t <= len; t += step) {
        ctx.save();
        ctx.translate(p1.x + (dx / len) * t, p1.y + (dy / len) * t);
        ctx.rotate(angle);
        ctx.drawImage(roadImg, -roadImg.width * scale / 2, -roadImg.height * scale / 2,
                roadImg.width * scale, roadImg.height * scale);
        ctx.restore();
      }
    }

    roadImg.onload = function() {
      network.on("beforeDrawing", function (ctx) {
        data.aristas.forEach(a => {
          const p1 = network.getPositions([a[0]])[a[0]];
          const p2 = network.getPositions([a[1]])[a[1]];
          if (p1 && p2) drawRoad(ctx, p1, p2);
        });
      });
      network.redraw();
    };

    alert("‚úÖ √Årbol m√≠nimo (Prim) cargado.\nPeso total: " + data.pesoTotal + " km");
  }
</script>

</body>
</html>
